# ApexBlog 图片上传问题分析与解决方案

## 问题概述

在 ApexBlog 项目的线上环境中，从管理后台 `https://admin.ilikexff.cn` 向后端 `https://ilikexff.cn/api` 上传图片时出现错误：

```
org.springframework.web.multipart.MultipartException: Current request is not a multipart request
```

## 问题分析

### 1. 表面现象
- **错误信息**：`Current request is not a multipart request`
- **发生环境**：线上生产环境
- **本地环境**：功能正常
- **影响功能**：文章封面、用户头像、通用图片上传

### 2. 根本原因分析

经过深入分析，发现了两个主要问题：

#### 问题1：CORS 跨域配置缺失 ⭐⭐⭐
**严重程度**：高

**问题描述**：
- 生产环境的 `application-prod.yml` 缺少 CORS 配置
- 前端域名 `https://admin.ilikexff.cn` 向后端 `https://ilikexff.cn` 发送跨域请求
- 浏览器 OPTIONS 预检请求失败，导致实际的 POST 请求被阻止

**影响**：
- 浏览器阻止跨域请求
- 后端收不到正确的 multipart 请求
- 导致 "Current request is not a multipart request" 错误

#### 问题2：前端 Content-Type 设置错误 ⭐⭐
**严重程度**：中

**问题描述**：
```javascript
// 错误的设置
headers: {
  'Content-Type': undefined  // ❌ 这会导致问题
}
```

**影响**：
- axios 可能将 `undefined` 处理为字符串 `"undefined"`
- 服务器收到错误的 Content-Type 头
- 无法正确识别 multipart 请求

## 解决方案

### 解决方案1：修复 CORS 配置 ✅

**文件**：`src/main/resources/application-prod.yml`

**修改内容**：
```yaml
# 生产环境CORS配置
cors:
  allowed-origins:
    - "https://admin.ilikexff.cn"  # 管理后台域名
    - "https://ilikexff.cn"       # 主站域名
  allowed-methods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
  allowed-headers: "*"
  allow-credentials: true
```

**修改位置**：第 72-84 行

### 解决方案2：修复前端 Content-Type 设置 ✅

**文件**：前端 `uploadApi` 相关代码

**修改前**：
```javascript
export const uploadApi = {
  uploadCover(file) {
    const formData = new FormData()
    formData.append('file', file)

    return api.post('/admin/upload/cover', formData, {
      headers: {
        'Content-Type': undefined  // ❌ 错误设置
      }
    })
  }
}
```

**修改后**：
```javascript
export const uploadApi = {
  uploadCover(file) {
    const formData = new FormData()
    formData.append('file', file)

    return api.post('/admin/upload/cover', formData)
    // ✅ 不设置 Content-Type，让 axios 自动处理
  },

  uploadAvatar(file) {
    const formData = new FormData()
    formData.append('file', file)

    return api.post('/admin/upload/avatar', formData)
  },

  uploadImage(file, folder = 'images') {
    const formData = new FormData()
    formData.append('file', file)

    return api.post(`/admin/upload/image?folder=${folder}`, formData)
  },

  deleteFile(fileUrl) {
    return api.delete('/admin/upload/file', {
      params: { url: fileUrl }
    })
  }
}
```

## 技术原理说明

### CORS 跨域机制
1. **预检请求**：浏览器发送 OPTIONS 请求检查跨域权限
2. **实际请求**：预检通过后发送真正的 POST 请求
3. **失败链路**：预检失败 → 实际请求被阻止 → 后端收不到请求

### multipart/form-data 机制
1. **Content-Type**：必须是 `multipart/form-data; boundary=xxx`
2. **boundary**：用于分隔不同的表单字段
3. **自动设置**：axios 和浏览器会自动为 FormData 设置正确的 Content-Type

## 部署步骤

### 后端部署
1. **确认配置**：检查 `application-prod.yml` 中的 CORS 配置
2. **重新构建**：`gradle build`
3. **重启服务**：确保新配置生效
4. **验证 CORS**：
   ```bash
   curl -X OPTIONS "https://ilikexff.cn/api/admin/upload/cover" \
     -H "Origin: https://admin.ilikexff.cn" \
     -H "Access-Control-Request-Method: POST" \
     -H "Access-Control-Request-Headers: authorization,content-type" \
     -v
   ```

### 前端部署
1. **修改代码**：更新 `uploadApi` 方法
2. **重新构建**：`npm run build`
3. **部署更新**：上传到服务器
4. **清除缓存**：确保浏览器使用新代码

## 验证方法

### 1. 浏览器开发者工具验证
- **Network 面板**：检查 OPTIONS 和 POST 请求
- **Response Headers**：确认包含正确的 CORS 头
- **Request Headers**：确认 Content-Type 正确

### 2. 功能测试
- **文章封面上传**：测试 `/admin/upload/cover`
- **用户头像上传**：测试 `/admin/upload/avatar`
- **通用图片上传**：测试 `/admin/upload/image`
- **文件删除**：测试 `/admin/upload/file`

### 3. 日志监控
- **后端日志**：确认收到正确的 multipart 请求
- **OSS 日志**：确认文件成功上传到阿里云
- **错误日志**：确认不再出现 multipart 相关错误

## 预防措施

### 1. 环境配置同步
- **开发环境**：`application-dev.yml`
- **生产环境**：`application-prod.yml`
- **配置检查**：部署前对比关键配置项

### 2. 前端最佳实践
```javascript
// ✅ 推荐：让 axios 自动处理
return api.post(url, formData)

// ❌ 避免：手动设置可能出错
return api.post(url, formData, {
  headers: { 'Content-Type': 'multipart/form-data' }
})
```

### 3. 测试覆盖
- **单元测试**：API 接口测试
- **集成测试**：跨域请求测试
- **端到端测试**：完整上传流程测试

## 相关文档

- [前端接口文档](./前端接口文档.md)
- [CORS 配置说明](https://spring.io/guides/gs/rest-service-cors/)
- [multipart/form-data 规范](https://tools.ietf.org/html/rfc7578)

---

**文档版本**：v1.0  
**创建时间**：2025-08-20  
**维护者**：ApexBlog 开发团队  
**状态**：已解决
