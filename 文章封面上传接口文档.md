# 文章封面图片上传功能使用文档

## 📋 功能概述

本文档介绍如何使用博客系统新增的文章封面图片上传功能。该功能集成了阿里云OSS存储服务，支持安全、高效的图片上传和管理。

## 🎯 主要特性

- ✅ 支持多种图片格式：JPG、PNG、GIF、WebP
- ✅ 文件大小限制：最大5MB
- ✅ 自动生成唯一文件名，避免冲突
- ✅ 按类型分文件夹存储（covers/avatars/images）
- ✅ 自动清理：删除文章时自动删除封面图片
- ✅ 安全验证：需要管理员权限
- ✅ 集成阿里云OSS，稳定可靠

## 🔧 配置信息

### 阿里云OSS配置
```yaml
# 已配置在 application-dev.yml 和 application-prod.yml
aliyun:
  oss:
    endpoint: https://oss-cn-beijing.aliyuncs.com
    access-key-id: YOUR_ACCESS_KEY_ID
    access-key-secret: YOUR_ACCESS_KEY_SECRET
    bucket-name: your-bucket-name
    base-url: https://your-bucket-name.oss-cn-beijing.aliyuncs.com/
```

## 📡 API接口说明

### 1. 上传文章封面图片

**接口地址：** `POST /admin/upload/cover`

**请求头：**
```
Authorization: Bearer YOUR_JWT_TOKEN
Content-Type: multipart/form-data
```

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | 图片文件 |

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "url": "https://your-bucket-name.oss-cn-beijing.aliyuncs.com/covers/20241220/abc123def456.jpg",
    "filename": "my-cover.jpg",
    "size": 1024000,
    "contentType": "image/jpeg"
  },
  "timestamp": 1703123456789
}
```

### 2. 上传用户头像

**接口地址：** `POST /admin/upload/avatar`

**请求参数：** 同上

### 3. 通用图片上传

**接口地址：** `POST /admin/upload/image`

**请求参数：**
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| file | File | 是 | - | 图片文件 |
| folder | String | 否 | images | 存储文件夹 |

### 4. 删除文件

**接口地址：** `DELETE /admin/upload/file`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| url | String | 是 | 要删除的文件URL |

## 💻 使用示例

### 1. 使用curl命令上传

```bash
# 上传文章封面
curl -X POST http://localhost:8888/api/admin/upload/cover \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..." \
  -F "file=@/path/to/cover.jpg"

# 上传头像
curl -X POST http://localhost:8888/api/admin/upload/avatar \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..." \
  -F "file=@/path/to/avatar.png"

# 删除文件
curl -X DELETE "http://localhost:8888/api/admin/upload/file?url=https://your-bucket-name.oss-cn-beijing.aliyuncs.com/covers/20241220/abc123.jpg" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..."
```

### 2. JavaScript前端示例

```javascript
// 上传文章封面
async function uploadCover(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/admin/upload/cover', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
    });
    
    const result = await response.json();
    if (result.code === 200) {
        console.log('上传成功:', result.data.url);
        return result.data.url;
    } else {
        console.error('上传失败:', result.message);
        throw new Error(result.message);
    }
}

// 使用示例
document.getElementById('coverInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        try {
            const imageUrl = await uploadCover(file);
            // 将图片URL设置到文章表单中
            document.getElementById('coverImageUrl').value = imageUrl;
            // 显示预览
            document.getElementById('coverPreview').src = imageUrl;
        } catch (error) {
            alert('上传失败: ' + error.message);
        }
    }
});
```

### 3. HTML表单示例

```html
<!-- 文章编辑表单 -->
<form id="articleForm">
    <div class="form-group">
        <label for="title">文章标题</label>
        <input type="text" id="title" name="title" required>
    </div>
    
    <div class="form-group">
        <label for="coverInput">封面图片</label>
        <input type="file" id="coverInput" accept="image/*">
        <input type="hidden" id="coverImageUrl" name="coverImage">
        <img id="coverPreview" style="max-width: 200px; display: none;">
    </div>
    
    <div class="form-group">
        <label for="content">文章内容</label>
        <textarea id="content" name="content" required></textarea>
    </div>
    
    <button type="submit">保存文章</button>
</form>
```

## ⚠️ 注意事项

### 文件限制
- **支持格式：** JPG、JPEG、PNG、GIF、WebP
- **文件大小：** 最大5MB
- **文件名：** 系统自动生成唯一文件名

### 权限要求
- 必须具有管理员权限
- 需要有效的JWT Token

### 存储规则
- 文件按日期分文件夹存储：`covers/20241220/`
- 文件名格式：`{UUID}.{扩展名}`
- 完整URL示例：`https://your-bucket-name.oss-cn-beijing.aliyuncs.com/covers/20241220/abc123def456.jpg`

### 自动清理
- 更新文章封面时，自动删除旧的封面图片
- 删除文章时，自动删除相关的封面图片
- 避免存储空间浪费

## 🔍 错误处理

### 常见错误码

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 401 | 未授权 | 检查JWT Token是否有效 |
| 403 | 权限不足 | 确保用户具有管理员权限 |
| 400 | 文件格式不支持 | 使用支持的图片格式 |
| 400 | 文件过大 | 压缩图片至5MB以下 |
| 500 | 服务器错误 | 检查OSS配置和网络连接 |

### 错误响应示例

```json
{
  "code": 400,
  "message": "文件大小不能超过5MB",
  "data": null,
  "timestamp": 1703123456789
}
```

## 🚀 快速开始

1. **确保应用已启动**
   ```bash
   java -jar apex-blog.jar --spring.profiles.active=dev
   ```

2. **获取管理员Token**
    - 使用管理员账号登录获取JWT Token

3. **测试上传功能**
   ```bash
   curl -X POST http://localhost:8888/api/admin/upload/cover \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -F "file=@test-image.jpg"
   ```

4. **集成到前端**
    - 参考上述JavaScript示例
    - 在文章编辑页面添加图片上传组件

## 📞 技术支持

如有问题，请检查：
1. 应用是否正常启动
2. 阿里云OSS配置是否正确
3. JWT Token是否有效
4. 文件格式和大小是否符合要求

---

**版本：** v1.0.0  
**更新时间：** 2024-12-20  
**作者：** xuyi
