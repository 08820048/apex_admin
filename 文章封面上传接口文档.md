# ApexBlog 图片上传接口文档

## 目录
- [1. 接口概述](#1-接口概述)
- [2. 认证授权](#2-认证授权)
- [3. 文件上传接口](#3-文件上传接口)
- [4. 错误码说明](#4-错误码说明)
- [5. 数据模型](#5-数据模型)
- [6. 使用示例](#6-使用示例)

## 1. 接口概述

### 1.1 基本信息
- **基础URL**: `http://localhost:8888/api`
- **数据格式**: JSON
- **字符编码**: UTF-8
- **请求方式**: POST、DELETE

### 1.2 统一响应格式
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": 1755664435000
}
```

## 2. 认证授权

### 2.1 Token获取
请先通过登录接口获取访问令牌：
```bash
curl -X POST "http://localhost:8888/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "xuyi", "password": "5247xff"}'
```

### 2.2 Token使用
在需要认证的接口请求头中添加：
```
Authorization: Bearer {token}
```

## 3. 文件上传接口

### 3.1 上传文章封面
**接口地址**: `POST /admin/upload/cover`

**权限要求**: 管理员权限

**请求头**:
```
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | 图片文件（支持jpg、png、gif、webp等格式，最大10MB） |

**cURL示例**:
```bash
curl -X POST "http://localhost:8888/api/admin/upload/cover" \
  -H "Authorization: Bearer {token}" \
  -F "file=@cover.png"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "文章封面上传成功",
  "data": {
    "url": "https://ultimate-img.oss-cn-beijing.aliyuncs.com/covers/20250820/ebdaf3b390d242a5ad9053a1ee72dd85.png",
    "filename": "cover.png",
    "size": 1024000,
    "contentType": "image/png"
  },
  "timestamp": 1755664435000
}
```

### 3.2 上传用户头像
**接口地址**: `POST /admin/upload/avatar`

**权限要求**: 管理员权限

**请求头**:
```
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | 头像图片文件（建议正方形，最大5MB） |

**cURL示例**:
```bash
curl -X POST "http://localhost:8888/api/admin/upload/avatar" \
  -H "Authorization: Bearer {token}" \
  -F "file=@avatar.png"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "用户头像上传成功",
  "data": {
    "url": "https://ultimate-img.oss-cn-beijing.aliyuncs.com/avatars/20250820/e962c688a1f64b6684f7f1b680c61941.png",
    "filename": "avatar.png",
    "size": 512000,
    "contentType": "image/png"
  },
  "timestamp": 1755664435000
}
```

### 3.3 通用图片上传
**接口地址**: `POST /admin/upload/image`

**权限要求**: 管理员权限

**请求头**:
```
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

**请求参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| file | File | 是 | - | 图片文件 |
| folder | String | 否 | images | 存储文件夹名称（如：articles、portfolios等） |

**cURL示例**:
```bash
curl -X POST "http://localhost:8888/api/admin/upload/image?folder=articles" \
  -H "Authorization: Bearer {token}" \
  -F "file=@image.png"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "图片上传成功",
  "data": {
    "url": "https://ultimate-img.oss-cn-beijing.aliyuncs.com/articles/20250820/f123456789abcdef.png",
    "filename": "image.png",
    "size": 2048000,
    "contentType": "image/png"
  },
  "timestamp": 1755664435000
}
```

### 3.4 删除文件
**接口地址**: `DELETE /admin/upload/file`

**权限要求**: 管理员权限

**请求头**:
```
Authorization: Bearer {token}
```

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| url | String | 是 | 要删除的文件完整URL |

**cURL示例**:
```bash
curl -X DELETE "http://localhost:8888/api/admin/upload/file?url=https://ultimate-img.oss-cn-beijing.aliyuncs.com/test/20250820/example.png" \
  -H "Authorization: Bearer {token}"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "文件删除成功",
  "data": null,
  "timestamp": 1755664435000
}
```

## 4. 错误码说明

### 4.1 通用错误码
| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 200 | 操作成功 | - |
| 400 | 请求参数错误 | 检查请求参数格式和必填项 |
| 401 | 未授权 | 检查token是否有效或重新登录 |
| 403 | 权限不足 | 确认用户具有管理员权限 |
| 404 | 资源不存在 | 检查请求的资源URL是否正确 |
| 500 | 服务器内部错误 | 联系技术支持 |

### 4.2 文件上传错误码
| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 1001 | 文件格式不支持 | 使用支持的图片格式（jpg、png、gif、webp） |
| 1002 | 文件大小超限 | 压缩文件后重新上传（最大10MB） |
| 1003 | 文件上传失败 | 检查网络连接，重试上传 |
| 1004 | OSS服务异常 | 检查OSS配置或联系技术支持 |
| 1005 | 文件删除失败 | 确认文件URL正确且文件存在 |

## 5. 数据模型

### 5.1 文件上传响应模型 (FileUploadResponse)
```typescript
interface FileUploadResponse {
  url: string;          // 文件访问URL
  filename: string;     // 原始文件名
  size: number;         // 文件大小（字节）
  contentType: string;  // 文件MIME类型
}
```

### 5.2 API统一响应模型 (ApiResponse)
```typescript
interface ApiResponse<T> {
  code: number;         // 状态码
  message: string;      // 响应消息
  data: T | null;       // 响应数据
  timestamp: number;    // 时间戳
}
```

## 6. 使用示例

### 6.1 JavaScript/TypeScript 示例
```typescript
// 上传文章封面
async function uploadCover(file: File, token: string): Promise<FileUploadResponse> {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch('http://localhost:8888/api/admin/upload/cover', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  });
  
  const result = await response.json();
  if (result.code === 200) {
    return result.data;
  } else {
    throw new Error(result.message);
  }
}

// 删除文件
async function deleteFile(fileUrl: string, token: string): Promise<void> {
  const response = await fetch(`http://localhost:8888/api/admin/upload/file?url=${encodeURIComponent(fileUrl)}`, {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  const result = await response.json();
  if (result.code !== 200) {
    throw new Error(result.message);
  }
}
```

### 6.2 Vue.js 组件示例
```vue
<template>
  <div class="upload-component">
    <div class="upload-area">
      <input
        type="file"
        @change="handleFileSelect"
        accept="image/*"
        class="file-input"
      />
      <button
        @click="uploadFile"
        :disabled="!selectedFile || uploading"
        class="upload-btn"
      >
        {{ uploading ? '上传中...' : '上传图片' }}
      </button>
    </div>

    <div v-if="uploadedUrl" class="preview-area">
      <img :src="uploadedUrl" alt="上传的图片" class="preview-image" />
      <button @click="deleteUploadedFile" class="delete-btn">删除图片</button>
    </div>

    <div v-if="error" class="error-message">{{ error }}</div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';

const selectedFile = ref<File | null>(null);
const uploading = ref(false);
const uploadedUrl = ref('');
const error = ref('');
const token = ref('your-jwt-token'); // 从登录状态获取

const handleFileSelect = (event: Event) => {
  const target = event.target as HTMLInputElement;
  selectedFile.value = target.files?.[0] || null;
  error.value = '';
};

const uploadFile = async () => {
  if (!selectedFile.value) return;

  uploading.value = true;
  error.value = '';

  try {
    const result = await uploadCover(selectedFile.value, token.value);
    uploadedUrl.value = result.url;
    console.log('上传成功:', result);
  } catch (err) {
    error.value = err instanceof Error ? err.message : '上传失败';
    console.error('上传失败:', err);
  } finally {
    uploading.value = false;
  }
};

const deleteUploadedFile = async () => {
  if (!uploadedUrl.value) return;

  try {
    await deleteFile(uploadedUrl.value, token.value);
    uploadedUrl.value = '';
    selectedFile.value = null;
    console.log('删除成功');
  } catch (err) {
    error.value = err instanceof Error ? err.message : '删除失败';
    console.error('删除失败:', err);
  }
};
</script>

<style scoped>
.upload-component {
  max-width: 400px;
  margin: 0 auto;
}

.upload-area {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.file-input {
  flex: 1;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.upload-btn {
  padding: 8px 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.upload-btn:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.preview-area {
  text-align: center;
}

.preview-image {
  max-width: 100%;
  max-height: 300px;
  border-radius: 4px;
  margin-bottom: 10px;
}

.delete-btn {
  padding: 6px 12px;
  background-color: #dc3545;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.error-message {
  color: #dc3545;
  margin-top: 10px;
  padding: 8px;
  background-color: #f8d7da;
  border-radius: 4px;
}
</style>
```

### 6.3 React 组件示例
```tsx
import React, { useState } from 'react';

interface FileUploadResponse {
  url: string;
  filename: string;
  size: number;
  contentType: string;
}

const ImageUpload: React.FC = () => {
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);
  const [uploadedUrl, setUploadedUrl] = useState('');
  const [error, setError] = useState('');
  const token = 'your-jwt-token'; // 从登录状态获取

  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    setSelectedFile(event.target.files?.[0] || null);
    setError('');
  };

  const uploadFile = async () => {
    if (!selectedFile) return;

    setUploading(true);
    setError('');

    try {
      const result = await uploadCover(selectedFile, token);
      setUploadedUrl(result.url);
      console.log('上传成功:', result);
    } catch (err) {
      setError(err instanceof Error ? err.message : '上传失败');
      console.error('上传失败:', err);
    } finally {
      setUploading(false);
    }
  };

  const deleteUploadedFile = async () => {
    if (!uploadedUrl) return;

    try {
      await deleteFile(uploadedUrl, token);
      setUploadedUrl('');
      setSelectedFile(null);
      console.log('删除成功');
    } catch (err) {
      setError(err instanceof Error ? err.message : '删除失败');
      console.error('删除失败:', err);
    }
  };

  return (
    <div style={{ maxWidth: '400px', margin: '0 auto' }}>
      <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
        <input
          type="file"
          onChange={handleFileSelect}
          accept="image/*"
          style={{ flex: 1, padding: '8px' }}
        />
        <button
          onClick={uploadFile}
          disabled={!selectedFile || uploading}
          style={{
            padding: '8px 16px',
            backgroundColor: uploading ? '#ccc' : '#007bff',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: uploading ? 'not-allowed' : 'pointer'
          }}
        >
          {uploading ? '上传中...' : '上传图片'}
        </button>
      </div>

      {uploadedUrl && (
        <div style={{ textAlign: 'center' }}>
          <img
            src={uploadedUrl}
            alt="上传的图片"
            style={{ maxWidth: '100%', maxHeight: '300px', borderRadius: '4px', marginBottom: '10px' }}
          />
          <br />
          <button
            onClick={deleteUploadedFile}
            style={{
              padding: '6px 12px',
              backgroundColor: '#dc3545',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer'
            }}
          >
            删除图片
          </button>
        </div>
      )}

      {error && (
        <div style={{
          color: '#dc3545',
          marginTop: '10px',
          padding: '8px',
          backgroundColor: '#f8d7da',
          borderRadius: '4px'
        }}>
          {error}
        </div>
      )}
    </div>
  );
};

export default ImageUpload;
```

---

**文档版本**: v1.0
**最后更新**: 2025-08-20
**维护者**: ApexBlog 开发团队
**技术支持**: 如有问题请联系开发团队
